generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Venda {
  id              Int            @id @default(autoincrement())
  data            DateTime       @default(now())
  total           Decimal        @db.Decimal(10, 2) // Recomendado definir precisão
  entrega         Boolean        @default(false)
  pagamento       String?        // Campo redundante se usar a tabela Pagamento, mas pode manter
  urlFiscal       String?
  statusEntrega   String?        @default("PENDENTE")
  enderecoEntrega String?
  
  // Dados fiscais
  nota_emitida    Boolean        @default(false)
  nota_id_nuvem   String?
  nota_chave      String?
  nota_numero     Int?
  nota_url_pdf    String?
  nota_cancelada  Boolean        @default(false)

  // Relacionamentos
  clienteId       Int?
  cliente         Cliente?       @relation(fields: [clienteId], references: [id])
  
  caixaId         Int?
  caixa           Caixa?         @relation(fields: [caixaId], references: [id])

  itens           ItemVenda[]
  pagamentos      Pagamento[]
  contaReceber    ContaReceber?

  @@map("vendas")
}

model ItemVenda {
  id         Int     @id @default(autoincrement())
  quantidade Decimal @db.Decimal(10, 3)
  precoUnit  Decimal @map("preco_unitario") @db.Decimal(10, 2)
  
  vendaId    Int     @map("venda_id")
  venda      Venda   @relation(fields: [vendaId], references: [id])
  
  produtoId  Int     @map("produto_id")
  produto    Produto @relation(fields: [produtoId], references: [id])

  @@map("itens_venda")
}

model Cliente {
  id           Int            @id @default(autoincrement())
  nome         String
  cpfCnpj      String?        @unique
  celular      String?
  
  // Endereço
  endereco     String?
  email        String?
  cep          String?
  rua          String?
  numero       String?
  bairro       String?
  cidade       String?
  estado       String?

  // Financeiro
  saldoHaver   Decimal        @default(0) @db.Decimal(10, 2)
  saldoDevedor Decimal        @default(0) @db.Decimal(10, 2)
  criadoEm     DateTime       @default(now())

  // Relacionamentos
  vendas       Venda[]
  contas       ContaReceber[]
  orcamentos   Orcamento[]

  @@map("clientes")
}

model User {
  id       String   @id @default(uuid())
  nome     String
  username String   @unique
  email    String   @unique
  senha    String
  cargo    String
  criadoEm DateTime @default(now())

  @@map("users") // Boa prática mapear para minúsculo no banco
}

model Produto {
  id            Int             @id @default(autoincrement())
  nome          String
  codigoBarra   String?         @unique
  
  precoCusto    Float
  precoVenda    Float
  estoque       Int
  
  unidade       String?
  categoria     String?
  fornecedor    String?
  localizacao   String?
  
  ipi           Float?          @default(0)
  icms          Float?          @default(0)
  frete         Float?          @default(0)

  // Fiscais
  ncm           String?
  cest          String?
  cfop          String?
  csosn         String          @default("102")
  origem        String          @default("0")

  // Relacionamentos
  itens          ItemVenda[]
  itensOrcamento ItemOrcamento[]

  @@map("produtos")
}

model ContaReceber {
  id             Int      @id @default(autoincrement())
  valor          Decimal  @db.Decimal(10, 2)
  status         String   @default("PENDENTE")
  data           DateTime @default(now())
  descricao      String?
  dataVencimento DateTime
  
  clienteId      Int
  cliente        Cliente  @relation(fields: [clienteId], references: [id])
  
  vendaId        Int      @unique
  venda          Venda    @relation(fields: [vendaId], references: [id])

  @@map("contas_receber")
}

model Pagamento {
  id      Int     @id @default(autoincrement())
  valor   Decimal @db.Decimal(10, 2)
  forma   String  // DINHEIRO, PIX, CARTAO, HAVER, A PRAZO
  
  vendaId Int
  venda   Venda   @relation(fields: [vendaId], references: [id])

  @@map("pagamentos")
}

model Orcamento {
  id        Int             @id @default(autoincrement())
  data      DateTime        @default(now())
  total     Decimal         @db.Decimal(10, 2)
  
  clienteId Int?
  cliente   Cliente?        @relation(fields: [clienteId], references: [id])

  itens     ItemOrcamento[]

  @@map("orcamentos")
}

model ItemOrcamento {
  id          Int       @id @default(autoincrement())
  quantidade  Decimal   @db.Decimal(10, 3)
  precoUnit   Decimal   @db.Decimal(10, 2)
  
  orcamentoId Int
  orcamento   Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  
  produtoId   Int
  produto     Produto   @relation(fields: [produtoId], references: [id])

  @@map("itens_orcamento")
}

model Caixa {
  id             Int                 @id @default(autoincrement())
  dataAbertura   DateTime            @default(now())
  dataFechamento DateTime?
  saldoInicial   Decimal             @db.Decimal(10, 2)
  saldoAtual     Decimal             @default(0) @db.Decimal(10, 2)
  saldoFinal     Decimal?            @db.Decimal(10, 2)
  status         String              @default("ABERTO")
  observacoes    String?
  
  movimentacoes  MovimentacaoCaixa[]
  vendas         Venda[]

  @@map("caixas")
}

model MovimentacaoCaixa {
  id        Int      @id @default(autoincrement())
  data      DateTime @default(now())
  tipo      String   // "VENDA", "SANGRIA", "SUPRIMENTO", "ABERTURA"
  valor     Decimal  @db.Decimal(10, 2)
  descricao String?
  
  caixaId   Int
  caixa     Caixa    @relation(fields: [caixaId], references: [id])

  @@map("movimentacoes_caixa")
}